name: Update OpenAI Assistant Instructions

on:
  push:
    branches:
      - main
    paths:
      - update_scenario_path.txt

jobs:
  update-instructions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Update OpenAI Assistant Instructions
        run: |
          # ファイルが存在するか確認
          if [[ -f update_scenario_path.txt ]]; then
            echo "Reading paths from update_scenario_path.txt..."
            while IFS= read -r path; do
              echo "Processing $path"
              # ここで任意の処理を実行
              # 例: ファイルの内容を表示
              if [[ -d $path ]]; then

                SETTING_FILE="${path}/setting.json"
                ASSISTANT_ID=$(jq -r '.assistant_id' "$SETTING_FILE")
                ASSISTANT_NAME=$(jq -r '.assistant_name' "$SETTING_FILE")
                MODEL=$(jq -r '.model' "$SETTING_FILE")
                TOP_P=$(jq -r '.top_p' "$SETTING_FILE")
                TEMPERATURE=$(jq -r '.temperature' "$SETTING_FILE")
                RESPONSE_FORMAT=$(jq -r '.response_format' "$SETTING_FILE")
                TENANT_NAME=$(jq -r '.tenant_name' "$SETTING_FILE")
                INSTRUCTION_FILE="${path}/instruction.txt"
                INSTRUCTION=$(cat "$INSTRUCTION_FILE")

                case "$TENANT_NAME" in
                "demo")
                  PROJECT_API_KEY="${{ secrets.OPENAI_DEMO_PROJECT_API_KEY }}"
                  ;;
                "rakuten-cc")
                  PROJECT_API_KEY="${{ secrets.OPENAI_RAKUTEN_CC_PROJECT_API_KEY }}"
                  ;;
                "rakuten-rookie")
                  PROJECT_API_KEY="${{ secrets.OPENAI_RAKUTEN_ROOKIE_PROJECT_API_KEY }}"
                  ;;
                "bs24")
                  PROJECT_API_KEY="${{ secrets.OPENAI_BS_24_PROJECT_API_KEY }}"
                  ;;
                *)
                  echo "Error: Unknown tenant_name ${TENANT_NAME}"
                  exit 1
                  ;;
              esac

                # 必要な変数の存在を確認
                if [[ -z "$ASSISTANT_ID" || -z "$PROJECT_API_KEY" || -z "$MODEL" || -z "$TOP_P" || -z "$TEMPERATURE" || -z "$RESPONSE_FORMAT" || -z "$INSTRUCTION" ]]; then
                  echo "Error: Missing one or more required variables."
                  exit 1
                fi

                # JSONデータの安全な生成
                JSON_PAYLOAD=$(jq -n \
                  --arg instructions "$INSTRUCTION" \
                  --arg model "$MODEL" \
                  --arg response_format "$RESPONSE_FORMAT" \
                  --argjson top_p "$TOP_P" \
                  --argjson temperature "$TEMPERATURE" \
                  '{
                    instructions: $instructions,
                    model: $model,
                    top_p: $top_p,
                    temperature: $temperature,
                    response_format: $response_format
                  }')

                # curlコマンドでリクエストを送信
                RESPONSE=$(curl -s -o response.json -w "%{http_code}" \
                  -X POST \
                  "https://api.openai.com/v1/assistants/${ASSISTANT_ID}" \
                  -H "Content-Type: application/json" \
                  -H "OpenAI-Beta: assistants=v2" \
                  -H "Authorization: Bearer ${PROJECT_API_KEY}" \
                  -d "$JSON_PAYLOAD")

                # HTTPステータスコードの確認
                if [[ "$RESPONSE" -ne 200 ]]; then
                  echo "Error: API request failed with status code $RESPONSE."
                  echo "Response:"
                  cat response.json
                  exit 1
                fi

                # 正常終了の場合
                echo "Request was successful. Response:"
                cat response.json

              else
                echo "$path does not exist."
                exit 1
              fi
            done < update_scenario_path.txt
          else
            echo "update_scenario_path.txt not found. Exiting."
            exit 1
          fi
